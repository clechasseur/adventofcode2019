import org.clechasseur.adventofcode2019.Pt
import org.clechasseur.adventofcode2019.dij.Dijkstra
import org.clechasseur.adventofcode2019.dij.Graph
import kotlin.math.min

object Day18 {
    private val input = """
        #################################################################################
        #.....#...........#....s..#.....#.......#...#...#...#...#.......#...........#...#
        #.#.#.#####.#.#####.#####.#.#####.#####.#.#.#.#.#.###.#.#.#.###.#.#.#########.#.#
        #.#.#.......#.#.........#.#.......#...#.#.#...#...#...#...#...#.#.#...#.......#.#
        #.#.#########.#.#########.#.#######.###.#.#####.###.#########.###.###.#.#######.#
        #l#...#...#...#...#.......#...#.....#...#.#.#...#...#.......#...#.#...#.#.......#
        #.###.#.###.#####.#.#########.###.#.#.###.#.#.###.#######.#.###.#.#.#.#.#.#####.#
        #.#...#...Z.#.#...#...#...........#.#...#.#.#.#.#.......#.#...#...#.#.#.#.....#.#
        #.#.#####.###.#.#####.###########.#####.#.#.#.#.#######.#.#########.###.#####M###
        #.#.#...#.#...#.....#.......#.....#...#.#.#...........#.#.......#...#...#...#...#
        #E#.#.#.#.###.#####.#######.#######.#.#.#.#######.#####.#.###.#.#.###.###.#####.#
        #.#...#.#.....#.....#.....#...#.....#.#.#.....#...#.....#.#.#.#.#...#.#.......#.#
        #.#####.#######.#########.###.#.#####.#.#.###.#####.#####.#.#.#####.#.#######.#.#
        #.#...#.........#...........#.#...#.....#...#.......#...#...#.....#.#.......#.#.#
        #.###.###########.#.#######.#.###.#####.###.#####.###.#.#####.#.#.#.#######.#.#.#
        #...#.....#x....#.#.#.....#.#...#.....#.#.#.#...#.....#.#...#.#.#.#.....L.#...#.#
        ###.#.#.#.###.#.#.###.###.###.#.#####.#.#.#.#.#.#######.#.#.###.#.#####.#####.#.#
        #.#.#.#.#...#.#...#...#.#...#.#.#.....#.#...#.#..b....#...#.....#.#...#.......#.#
        #.#.###.###.#.###.#.###.###.###.#.#####.#.###C#######.#############.#.#########.#
        #.#...#o#...#.#.#.#.#.....#.....#.....#.#..f#.#.....#.........#.....#.#.....#...#
        #.###.#.###.#.#.#.#.#####.#######.###.#####.#.#####.#########B#.#####.#.###.#.#.#
        #...#.#...#...#.#.#.#...#.......#...#...#...#.....#.........#.#.#.......#...#.#.#
        #.#.#.###.#####.#.#.###.###.###.#######.#.#######.#####.###.###.#.#######.###.#.#
        #.#.#.....#.....#.#...#...#...#.........#.#...N.#c....#...#t..P.#...#...#.....#.#
        #.#########.#####.#.#####.###.#####.#####.#.#########H###.###########.#.#.#######
        #.........#..g....#.....#...#.#.....#...#.#...#.....#...#.#...........#.#.#.....#
        #.#####.###.###########.###.#.#######.#.#.###.#.#.#####.#.#.###########.###.###.#
        #...#.#...#...#...#.....#...#.#.......#.#.#...#.#.......#...#.......#.#.......#.#
        ###.#.###.###.###.#.#####.###.#.#######.#.#.#.#.#########.#####V###.#.#########.#
        #.#.#.#.....#.#...#.......#.#...#...#...#...#.#......y#.#.#.....#.#...#.I.....#.#
        #.#.#.#.#.###.#.###########.#.###.###.#.#####.#######.#.#.#.#####.###.#.#####.#.#
        #.....#.#.#...#.......#.......#...#...#.#.....#.#.....#.....#...#...#.#.#.......#
        #.#####.###.#######.#.#.#######.#.#.#####.#####.#.#############.#.#.#.#.#########
        #.#.#a..#...#.....#.#...#.......#.#.....#.#.....#...#..j#.......#.#.#.#.....#...#
        #.#.#.#.#.###.###.#.###########.#.#####.#.#.#######.#.#.###.#####.#.#.#####.#.#.#
        #.#.#.#.#.....#...#.#...........#...#...#.#.......#...#...#.....#.#..d....#...#.#
        #.#.#F#.#######.###.#.#########.#####.###.#.###.#########.#####.#.#############.#
        #.#.#.#.......#...#...#.........#...#...#.#...#.....#.#...#...#...#...#...#...U.#
        #.#.#.###########.###############.#.###.#.#######.#.#.#.###.#.#####.#.#.#.#.###.#
        #...#.............................#...............#...#.....#..q....#...#..r#...#
        #######################################.@.#######################################
        #.........#.....#.........#.........#.........#...........#.........#.........#.#
        #.#######.#.#.###.#####.#.#####.###.#.#.#.#####.###.#######.#####.###.###.###.#G#
        #.#.....#.#.#.......#...#.......#.#.#.#.#.#.....#.#.......#.#.....#.A...#...#...#
        #.#.###.#.###.#######.###########.#.###.#.#.#####.#######.#.#.#####.#######.###.#
        #.#...#.#...#.#...#...#.......#.....#...#.........#.....#.#.#.......#.....#...#.#
        #.#####.###.#.###.#.#.#.#####.#.#####.#.###########.###.#.#.#########.###.###.#.#
        #.....#.....#.....#.#.#.#.#...#.#...#.#.#...#.....#.#.#.#...#.....#...#.......#.#
        #.###.#.#########.#.###.#.#.###.#.#.#.#.#.#.#.###.#.#.#.#.###.###.#.#X#########.#
        #w..#.#.#.....#...#...#.#.#.#.....#n..#.#.#.#.#.#...#.#.#.#...#...#.#.#...#...#.#
        ###.#.#.###.###.#####.#.#.#.#############.#.#.#.#####.#.#.#.###.###.#.#.#.#.###.#
        #...#.#...#.#...#...#...#.#.#...........#.#...#.......#.#.#.#.#.#...#.#.#.#.....#
        #.###.###.#.#.###.#######.#.#.#########.#.###########.#.###.#.#.###.###.#.#######
        #.#...#.#.#.....#.........#...........#.#...#.........#.....#.#...#...#.#.......#
        #.#.###.#.#####.#####.#########.#######.#.#.#.###############.###.###.#.#######.#
        #.#.#.#..m#...#.......#...#...#.#...#...#.#.#...#.......#.......#...#...#.#.....#
        ###.#.#.###.#.#########.#.#.#.###.#.#.#.#.#.###.#.#####.#.###.#####.#.###.#.#####
        #...#...#...#...........#...#.....#...#.#.#...#.#.#.#...#...#.....#.#.#...#.....#
        #.###.###.#.###########################.#.###.#.#.#.#.###.#######.#.#.#.#O#####.#
        #p#.#.#...#.#...J.......#...#.......#...#...#.#.....#.....#.....#.#.#...#...#...#
        #.#.#K#.###.#.#####.###.#.#.#.#####.#.#####.#.#############.###.#.#.#######.#.#.#
        #.#.#.#...#.#.#.....#.#...#.#.#.....#...#.#.#...#.........#.#...#.#...#.#e..#.#.#
        #.#.#.#.#.#.#.###.###.#####.###.#######.#.#.###.#.#######.#.#####.###.#.#.###.#.#
        #.#.#.#.#.#.#...#...#h..#.#.Q.#.....#...#.#.#.#.#...#...#.#.#.#.....#.#.#...#.#.#
        #.#.#.###.#.###.#######.#.###.#.###.#.###.#.#.#.###.###.#.#.#.#.#.#.#.#.#.###.#.#
        #.#.#.#...#...#.....Y...#...#.#.#.#...#.#...#.#.........#.#.#...#.#.#.#...#...#.#
        #.#.#.#.###.#############.###.#.#.#####.#.###.###########.#.###.#.#.#.#####.###.#
        #.#.....#...#.........#.R...#.#.#.......#.#...#.....#.....#...#.#.#.#.......#...#
        #.#######.###.###.#####.###.#.#.#.#####.#.#.#.#.###.#.#.#####.#.#.#.#########.###
        #.....#...#...#.#.#...#.#.#...#.#...#.#.#.#.#.#.#.....#.#.....#.#.#.#......k#...#
        #.###.#####.###.#.#.#.#.#.#####.###.#.#.#.#.#.#.#.#######.#####.#.###.#.###.###.#
        #...#.#.....#...#...#.#.......#...#...#.#.#.#.#.#.#.#.....#...#.#.#...#.#.....#.#
        ###.#.#.#####D#.#####.#######.###.#.###.#.#.#.#.#.#.#.#####.###.#.#.###.#######.#
        #...#...#.....#i#.........#.#.#...#.#...#.#.#.#.#...#...#.......#...#.#.......#.#
        #.#######.#######.#######.#.#.#.#####.#.#.###.#.###.###.#.###########.#######.#.#
        #.#...#.........#...#.......#.#.......#.#.....#...#...#.#.#.......#.........#..z#
        #.#T#.###.#####.###.#########.#########.#####.###.#####.#.#####.#.###.#####.#####
        #...#...#.#...#.#...#...#...#.........#.#...#.#.#.#...#.#.....#.#...#.#.....#...#
        #######.###.#.#.#.###.#.#.#.#########.#.#.#.#.#.#.#.#.#.#####.#S###.###W###.#.#.#
        #...........#...#.....#...#..u........#.#.#....v#...#...#.......#.......#.....#.#
        #################################################################################
    """.trimIndent()

    private val startingLabyrinth = input.lineSequence().mapIndexed {
        y, line -> line.mapIndexed { x, c -> Pt(x, y) to c }
    }.flatten().toMap()
    private val startPos = startingLabyrinth.filter { it.value == '@' }.keys.first()

    fun part1() = getKeys(from = startPos, labyrinth = startingLabyrinth)

    private fun getKeys(from: Pt, labyrinth: Map<Pt, Char>, soFar: Long = 0,
                        shortestSoFar: Long = Long.MAX_VALUE, keyPath: String = ""): Long {

        val keys = labyrinth.filter { it.value.isLowerCase() }
        if (keys.isEmpty()) {
            println("WINNER ($soFar steps): $keyPath")
            return soFar
        }
        val (dist, _) = Dijkstra.build(LabyrinthGraph(labyrinth), from)
        var shortest = shortestSoFar
        for ((keyPos, key) in keys.asSequence().sortedBy { dist[it.key] }) {
            val distToKey = dist[keyPos]
            if (distToKey != null && distToKey != Long.MAX_VALUE && soFar + distToKey < shortest) {
                val newLabyrinth = labyrinth.map {
                    when (it.value) {
                        key, key.toUpperCase() -> it.key to '.'
                        else -> it.key to it.value
                    }
                }.toMap()
                shortest = min(shortest, getKeys(keyPos, newLabyrinth, soFar + distToKey,
                        shortest, "$keyPath -> $key"))
            }
        }
        return shortest
    }

    private fun explore(graph: Graph<Pt>, pt: Pt): Set<Pt> {
        val passable = mutableSetOf<Pt>()
        explore(graph, pt, passable)
        return passable
    }

    private fun explore(graph: Graph<Pt>, pt: Pt, passable: MutableSet<Pt>) {
        if (!passable.contains(pt)) {
            passable.add(pt)
            graph.neighbours(pt).forEach { explore(graph, it, passable) }
        }
    }

    private class LabyrinthGraph(private val labyrinth: Map<Pt, Char>) : Graph<Pt> {
        companion object {
            private val directions = listOf(Pt(1, 0), Pt(-1, 0), Pt(0, 1), Pt(0, -1))
        }

        override fun allPassable(): List<Pt>
                = labyrinth.filter { it.value != '#' && !it.value.isUpperCase() }.keys.toList()

        override fun neighbours(node: Pt): List<Pt> = directions.map { it + node }.filter {
            val type = labyrinth[it]
            type != null && type != '#' && !type.isUpperCase()
        }

        override fun dist(a: Pt, b: Pt): Long = 1
    }
}
