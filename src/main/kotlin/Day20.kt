import org.clechasseur.adventofcode2019.Pt
import org.clechasseur.adventofcode2019.dij.Dijkstra
import org.clechasseur.adventofcode2019.dij.Graph

object Day20 {
    private val modifiedInput = """
                                         a       b   c           d   e f       g                                           
  #######################################.#######.###.###########.###.#.#######.#########################################  
  #...#.........#.#...#.#...#.........#.....#.#.....#.......#...#...#.....#.#...........#...........#.......#...#.......#  
  ###.#########.#.#.###.#.#######.###.###.###.#####.#.###.###.#####.###.###.#####.#.#######.#####.###.#.#####.#####.#####  
  #.#.....#...........#...#...#.#.#.....#.....#.#...#.#.....#.#.#.....#.....#.....#.#.#.#.......#.#...#.....#.#.#.....#.#  
  #.#####.#####.###.#####.###.#.#######.#.#.###.#.#####.###.#.#.#.#########.#.#.#####.#.###.#######.#.#######.#.###.###.#  
  #...#...#.....#...#.#...#.#.#...#.#.....#.#.......#...#.#.#...#.#.#.......#.#.#...............#.#.#.........#.#.#.....#  
  ###.#.#.#########.#.###.#.#.#.###.#.#.#########.#####.#.#.#.#.#.#.###.#####.###.#.#.#.###.#.###.###.#######.#.#.#.#####  
  #.....#...#.....#.........#...#.#...#.........#.....#.#...#.#.....#.....#.#.#...#.#.#.#...#...........#...#.........#.#  
  #########.#####.#.#.#.#.#.###.#.#######.#####.###.#####.###.###.###.#####.#.#.###.#.#.###.#.#####.#.###.#########.###.#  
  #.#.........#.....#.#.#.#.#.......#.......#.#.#.......#.#...#.#...#...#...#.....#.#.#...#.#.....#.#.............#.#...#  
  #.###.###.#####.#########.###.#####.###.#.#.#####.#####.###.#.###.#.###.###.#.###.#######.###.#.#.#.#######.#####.###.#  
  #...#...#.....#.#.#...#.........#...#...#.#.....#.#.#.....#...#...#.......#.#.#.........#...#.#.#.#.......#.#...#.#.#.#  
  #.#########.###.#.#.#####.#.###.###.#######.###.#.#.#.###.###.###.#.#.#.###.#####.#.###.#.#.###.#.#.#.#######.#.###.#.#  
  #...#.......#.#.#.....#.#.#.#...........#.....#.....#.#...#.....#.#.#.#.#.......#.#.#...#.#.#.#.#.#.#...#...#.#.#.#...#  
  #.#########.#.###.###.#.###########.#########.###########.#.###.###.###.#########.#########.#.#####.#.###.###.###.###.#  
  #...#.#.#.......#.#.....#.....#.....#.#.......#.#...#.#...#...#.#.#.#.#.#...#...........#.#.....#...#.....#...#.......#  
  ###.#.#.#####.#####.###.#####.#####.#.#####.###.###.#.###.#.#####.#.#.###.#######.#######.#.#######.#.###.###.#####.###  
  #.....#.#.#.#.....#.#.#.........#.#.....#.#...........#...#.....#.........#...#...#...#...#.#.#...#.#.#.#...#.#.#.....#  
  #.#.#.#.#.#.#.#######.#########.#.###.###.###.#####.#####.#.#######.#########.###.###.###.###.#.#####.#.#####.#.#.#.###  
  #.#.#.......#.....#.#.#.#.#.#.#.#.....#...#...#.#.#.#...#.#.#.#.#.....#...#...#...#...#.....#.....#.#.#.#...#...#.#.#.#  
  #####.#####.#.#####.#.#.#.#.#.#.###.#####.#.###.#.###.###.#.#.#.#.#.###.###.#.#.#####.#.#.#######.#.###.#.#####.###.#.#  
  #.#.#.#.....#.....#.......................#...#...#.......#.....#.#.#.......#.#.........#...#.#.#.#...#.....#.#.#.....#  
  #.#.#######.#.#######.###.#.#####.#######.#.#####.#.#.###.###.#####.#######.#.###.#######.#.#.#.#.#.#####.###.#.###.###  
  #...#...........#.#.#.#...#.#...#.#...#.#.#.....#...#...#.#...#...........#.#...#.....#.#.#...........#...#...#.#...#.#  
  ###.#.#.###.#.###.#.#.#.#####.#####.###.#.#.#######.#.#.#.#.###########.###.###.#.#.#.#.#.#.#.#.###.#.###.###.#.#.#.#.#  
  #.....#.#.#.#.#.....#.#...#...#.#.#.....#.#.....#...#.#.#.#...#.#.#...#.#...#.#.#.#.#.#.#.#.#.#.#.#.#...#.......#.#...#  
  ###.#.#.#.#.#####.###########.#.#.#.###.#.#.#####.#.#######.###.#.#.#.#.#.#.#.#.#.#####.#.#######.#######.#.###.#.#####  
  #.#.#.#.#...#.#.......#.......#.....#.#.#.#...#.#.#.......#.......#.#...#.#.#.#...#.#...#.#...#...#...#...#.#...#.....#  
  #.#########.#.###.#.#####.#.#.#####.#.#.#.###.#.###.###.#########.#.#######.#.#####.###.###.###.#####.#########.###.###  
  #.....#.#.#.#.....#...#...#.#.#.......#...#.....#.....#...#.......#.....#.................#...#...#.........#.#.#.#...#  
  #.#####.#.#.#######.#######.#########.#########.#########.#.#########.#.#######.#########.#.###.#####.#######.#.#.#.###  
  #.....#.#.#.#...#.#.#.#.#.#...#      s         o         y r         q m       u        #.#.....#.#.#...#.#.#.........#  
  #.#####.#.#.#.###.#.#.#.#.#.###                                                         ###.#####.#.###.#.#.###.###.###  
  #...#.#.#.#.#.#...#.......#...#                                                         #.......#.....#...#...#.#.#...#  
  #.###.#.#.#.#.###.#.#.###.#.#.#                                                         #.#.#######.###.#.###.#.#.#.###  
 h....#.#.#...#...#...#...#...#.#                                                         #.#.#.#.#...#.#.#.....#.#.#.#.#  
  #.###.#.###.#.###.#.#.#.###.#.#                                                         #.###.#.#.###.###.#######.#.#.#  
  #.......#.#.......#.#.#.#...#..l                                                       c..#.........#.#.....#.#.......#  
  #.#.#.###.###.#.#.###########.#                                                         #.###.###.###.#.#.#.#.###.###.#  
  #.#.#.........#.#.#.....#...#.#                                                         #.#.#...#.......#.#.......#....1 
  #############.#.#####.###.#####                                                         #.#.###.#########.#.#.###.###.#  
 i..#.........#.#...#.#.#.#.....#                                                         #.#...#.....#.#.#.#.#...#...#.#  
  #.#.###.#.#####.###.#.#.###.#.#                                                         #.#.#.###.###.#.###########.#.#  
  #...#.#.#.#.#.#.#...#.....#.#.#                                                         #...#.....#.#.#.#...#.#...#.#.#  
  #.###.###.#.#.###.#.#.#.###.###                                                         ###########.#.#.#.###.###.###.#  
  #...#.#...........#...#........v                                                        #.......#...............#...#.#  
  ###.#.#####################.###                                                         #.#####.#.###.###.#####.#.#.###  
 j..#.#...#.................#...#                                                        b..#.#.....#...#...#.#.#...#.#..z
  #.###.#.#####.#.###.#.#.###.###                                                         #.#.#.###.###.#.#.#.#.#####.#.#  
  #.#...#...#...#.#...#.#.#.#...#                                                         #.#...#.#.#.#.#.#.#.#.......#.#  
  #.#.#####.#.#.#.###.###.#.#####                                                         #######.###.#######.#.#######.#  
  #.#.#.....#.#.#...#.#.#.......#                                                         #.#.......#.....#.#.#.........#  
  #.#.#.#######.#######.###.#.#.#                                                         #.#####.#.###.###.#.###########  
  #...#...........#...#...#.#.#..g                                                        #...#.#.#.........#...........#  
  #######.#########.###.###.#####                                                         #.#.#.###.###.###.###.#.#.#.###  
 k..#.#.#.#...............#.#.#.#                                                         #.#...#.#.#.#.#.......#.#.#....y 
  #.#.#.#.#.#.#.###.#####.###.#.#                                                         #.###.#.#.#.#########.#########  
  #.....#.#.#.#...#.#.....#.#.#..d                                                        #.#.....#...#.....#.#.....#...#  
  #####.###.#####.#.#####.#.#.#.#                                                         #.#.#.#.###.###.###.#########.#  
 #^.......#.....#.#.#...#.......#                                                        z..#.#.#.....#...#...#.#.#.#...#  
  #.#######.###########.###.###.#                                                         ###.###########.###.#.#.#.###.#  
  #...........#.#.#.#.....#.#.#.#                                                         #...#...#.......#..............x 
  #.#.#.#.#.#.#.#.#.###.#####.###                                                         #####.#.#.#.###.#.#.###.###.#.#  
  #.#.#.#.#.#.....#.............#                                                         #.#...#...#.#.....#.#...#...#.#  
  #################.#########.###                                                         #.#.###.#.#########.###########  
  #.....#.#.#.#.......#.....#...#                                                         #.#...#.#.#.......#.#.#.....#.#  
  #.#.###.#.#.#######.#.###.###.#                                                         #.#.###.#.#.#########.#.#####.#  
  #.#.#...#...#.#...#.....#.#.#.#                                                        t....#.#.#.#.#.#.....#...#.#...#  
  #.#.#.#.#.###.#.#.#######.#.#.#                                                         #####.#####.#.#.#.#####.#.#.###  
 l..#...#.........#.........#.#..k                                                        #...............#.#.#..........w 
  #.###########.###.#########.###                                                         #.#########.###.###.###.#####.#  
  #.#.......#...#...#...........#                                                         #.#.....#...#...#...#.......#.#  
  ###.#####.###.#########.#.###.#                                                         #.#.###.#.#.#####.#.#####.#.#.#  
 m..#...#.....#.#.........#.#....w                                                       h..#...#...#.#.#.#.#...#...#.#.#  
  #.#.###.#.###########.#.#.#####                                                         #.###.#######.#.###.#.#.#####.#  
  #.#.#...#.#.#.#.#.#...#.#.....#                                                         #...#...............#.....#.#.#  
  #.#.#.#####.#.#.#.###.###.#####                                                         #.#.###############.#.#.###.#.#  
  #...#...................#.....#                                                         #.#.#...........#...#.#.#...#.#  
  ###############.###############                                                         #.#.###.#######.###########.###  
  #...........#.#.#.............#                                                         #.#.#.....#...........#...#.#.#  
  #####.#.#.###.###.#######.###.#                                                         #########.#.#.###########.#.#.#  
  #.....#.#.#.#.#.........#.#...#                                                         #.#.#.....#.#.#...#...#...#....v 
  #.#####.###.#.#######.#####.###                                                         #.#.###.#.#.#########.###.#.#.#  
 #$...#...#...#.#...........#.#.#                                                        a........#.#.................#.#  
  ###.#.###.#.#.###.#.#.#####.#.#                                                         #.###.#.###.#.#.#####.###.#.###  
 n....#.....#.......#.#...#......j                                                        #.#...#...#.#.#...#.....#.#...#  
  #.#.#######.#.#####.#.#####.###                                                         #.###.#########.###.#.#####.#.#  
  #.#.#.......#.#.#.#.#.....#.#.#                                                         #.#...#...........#.#.#.#...#.#  
  #.#.###.#.#.###.#.#.#######.#.#                                                         #.#####.###.#.###.#.###.###.#.#  
  #.#.#...#.#...#.....#.#.......#    e     n           i       f     p     1       x      #.#.....#...#...#.#.#.#.....#.#  
  #.#.#.#.###.#.#.#.#.#.#.###.#.#####.#####.###########.#######.#####.#####.#######.###############.#.#.#.###.#.#.#.#.###  
  #.#.#.#.#...#.#.#.#...#...#.#.#.......#.......#...#.....#.....#.......#...#...#.........#.#.#.....#.#.#.#.#.#...#.#.#.#  
  ###.#####.#.#######.###.###.#######.#####.#####.###.#######.###.#######.###.#.#.#.#.###.#.#.###.#####.###.#########.#.#  
  #.....#.#.#.....#...#...#.#.#...........#.........#.....#...#.#.....#.#.....#.#.#.#.#.....#...#.#.#.........#.........#  
  #.#####.#.###.#####.#####.#.#.###.###.#.###.#.###.#####.#.#.#.#.#####.###.###.#.#####.#.###.#####.###.###.###.#.#.###.#  
  #...#...#...#.#.........#...#.#...#.#.#.#.#.#...#.#.....#.#...#.......#.#.#...#.#...#.#.#.....#.#.....#.....#.#.#.#...#  
  #######.#####.#####.#######.#####.#.#.###.#####.#####.###.###########.#.#####.#.#.#########.###.###.#.###.#######.###.#  
  #.......#.#.....#...#.........#...#.#.#...#.........#...#.#.#.......#...#.#.#.#...#...#...#.#.....#.#.#.#.#.........#.#  
  #.#.#.#.#.#.#####.#####.###.#####.#.#.#.#####.#.#.#.###.#.#.#####.#.#.###.#.#.#.###.###.###.###.###.###.###.#.###.#####  
  #.#.#.#.......#...#...#.#...#.......#.#...#...#.#.#.#.#.#.....#...#.#.....#...#...#.#.#.........#.#...#...#.#.#.......#  
  #######.###.###.#.#.###############.###.#####.###.###.#.#.#.#.#.#.#.#.###.###.###.#.#.#.###.#.###.###.#.#.#.#####.#.#.#  
  #...#.#.#.....#.#.#.#.........#.#.........#.....#.#...#.#.#.#.#.#.#.....#.#...#...#...#...#.#.....#.#.#.#.......#.#.#.#  
  #.###.###.#.#####.#.#########.#.#######.#.###.#####.###.#.#.#####.###.#######.#.###.###.#######.#.#.#####.#.#.#.###.###  
  #.....#...#...#.#.....#...............#.#.#.....#.......#.#.#.....#.#...#.....#.....#.....#.....#.....#.#.#.#.#.#.....#  
  #####.#.#.###.#.#.#########.#####.###.#.###.###.#######.#.#####.###.#.#.#####.#.###.#.#.#######.#.#.###.#.#######.#.#.#  
  #.......#.#.#.#.....#.......#.#...#.#.....#.#...#.#.#...#...#.......#.#.#.....#.#.....#...#...#.#.#.#.......#.#.#.#.#.#  
  #.###.#.#.#.###.#######.#####.#.#.#####.#.###.###.#.#.#.#.#####.#####.#####.###.#.###.###.#.###.#.###########.#.#.#.#.#  
  #.#.#.#.#...#...#...#.#.#.#.#.#.#.....#.#...#...#.....#.#...#.#.....#.#.......#.#.#...#.#.....#.#.#.........#...#.#.#.#  
  #.#.#.#.#.###.#####.#.###.#.#.###.#######.#####.#.###.###.#.#.#.#############.#######.#.#.###.#####.#.###.###.#####.###  
  #.#.#.#.#...#...#.#.....................#.#.....#...#.#...#...#.#...#.#.......#...#.#...#.#.#.#.....#.#.........#.#...#  
  #.#.#.#.#.#######.#####.#####.#####.#########.#.#.#########.#.#.###.#.#####.###.###.#.#.###.#####.#########.#####.#####  
  #.#...#.#.#...#.........#.#.#.#.......#...#.#.#.#.........#.#.#.#.....#...........#...#.#.......#.#.#.#.#...........#.#  
  #.#######.###.###.#######.#.#####.#####.###.#.#######.#####.###.###.#.###.###.#######.#######.###.#.#.#.###.###.###.#.#  
  #.....#.#.#.#.#.#.#.#.....#.........#.........#.#...#...#.#...#.....#.#.#...#.#.#.#.#.....#...............#...#.#.....#  
  #.#####.###.#.#.###.#####.#######.#####.#.###.#.#.#.#.###.#.#########.#.#.###.#.#.#.#.#########.#####.#.#.#######.#.#.#  
  #.#.#.......................#.#.#.#...#.#.#.....#.#...#.#...#.#.#.......#.#.....#.#...#...#.........#.#.#.......#.#.#.#  
  #.#.#.###.#####.#########.#.#.#.#.#.###########.#.###.#.#.###.#.###.###.###.#####.###.###.#.#.#.#.###.#####.#.###.#####  
  #.#...#.#.#.#...#.........#.........#...#.#.....#...#.#.......#...#...#.#.....#...#.........#.#.#...#...#...#.#.#...#.#  
  #######.###.###.#####.#####.#####.#.#.###.###.###.#######.#.#.#.#####.#######.#.#.#.#####.#####.#.#.#.#####.###.#####.#  
  #...............#.....#.......#...#.....#.......#.....#...#.#.#.......#.......#.#.......#.....#.#.#.#.....#...........#  
  #####################################.#####.#######.#######.###.#########.#####.#######################################  
                                       o     p       q       r   s         t     u                                         
    """.trimIndent()

    private val tiles = modifiedInput.lineSequence().mapIndexed { y, line ->
        line.mapIndexed { x, c -> Pt(x, y) to c }
    }.flatten().filter { it.second != '#' && it.second != ' ' }.toMap()

    private val portals = tiles.asSequence().filter {
        it.value.isLetterOrDigit()
    }.fold(mutableMapOf<Char, MutableList<Pt>>()) { acc, (pt, c) ->
        acc.getOrPut(c) { mutableListOf() }.add(pt)
        acc
    }.map { it.key to it.value.toSet() }.toMap()

    private val start = tiles.filter { it.value == '^' }.keys.single()
    private val end = tiles.filter { it.value == '$' }.keys.single()

    fun part1(): Long {
        val (dist, _) = Dijkstra.build(PlutoGraph(), start)
        return dist[end]!!
    }

    private class PlutoGraph : Graph<Pt> {
        companion object {
            private val directions = listOf(Pt(1, 0), Pt(-1, 0), Pt(0, 1), Pt(0, -1))
        }

        override fun allPassable(): List<Pt> = tiles.filter { it.value == '.' }.keys.toList() + start + end

        override fun neighbours(node: Pt): List<Pt> = directions.mapNotNull { move ->
            val dest = node + move
            when (val c = tiles[dest]) {
                null -> null
                '.', '^', '$' -> dest
                else -> neighbours(portals[c]!!.single { it != dest }).single()
            }
        }

        override fun dist(a: Pt, b: Pt): Long = 1L
    }
}
